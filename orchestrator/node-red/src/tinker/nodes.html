<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/x-red" data-template-name="change">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
    <div class="form-row" style="margin-bottom:0;">
        <label><i class="fa fa-list"></i> <span data-i18n="change.label.rules"></span></label>
    </div>
    <div class="form-row node-input-rule-container-row">
        <ol id="node-input-rule-container"></ol>
    </div>

</script>

<script type="text/x-red" data-help-name="change">
    <p>Set, change, delete or move properties of a message, flow context or global context.</p>
    <p>The node can specify multiple rules that will be applied in turn.</p>
    <p>The available operations are:</p>
    <ul>
        <li><b>Set</b> - set a property. The value can be a variety of different types, or
            can be taken from an existing message or context property.</li>
        <li><b>Change</b> - search &amp; replace parts of the property. If regular expressions
            are enabled, the <b>replace with</b> property can include capture groups, for
            example <code>$1</code>. Replace will only change the <b>type</b> if there
            is a complete match.</li>
        <li><b>Delete</b> - delete a property.</li>
        <li><b>Move</b> - move or rename a property.</li>
    </ul>

</script>

<script type="text/javascript">
    RED.nodes.registerType('change', {
        color: "#E2D96E",
        category: 'function',
        defaults: {
            name: {value: ""},
            rules: {value: [{t: "set", p: "payload", pt: "msg", to: "", tot: "str"}]},
            // legacy
            action: {value: ""},
            property: {value: ""},
            from: {value: ""},
            to: {value: ""},
            reg: {value: false}
        },
        inputs: 1,
        outputs: 1,
        icon: "swap.png",
        label: function () {
            if (this.name) {
                return this.name;
            }
            if (!this.rules) {
                if (this.action === "replace") {
                    return this._("change.label.set", {property: "msg." + this.property});
                } else if (this.action === "change") {
                    return this._("change.label.change", {property: "msg." + this.property});
                } else if (this.action === "move") {
                    return this._("change.label.move", {property: "msg." + this.property});
                } else {
                    return this._("change.label.delete", {property: "msg." + this.property});
                }
            } else {
                if (this.rules.length == 1) {
                    if (this.rules[0].t === "set") {
                        return this._("change.label.set", {property: (this.rules[0].pt || "msg") + "." + this.rules[0].p});
                    } else if (this.rules[0].t === "change") {
                        return this._("change.label.change", {property: (this.rules[0].pt || "msg") + "." + this.rules[0].p});
                    } else if (this.rules[0].t === "move") {
                        return this._("change.label.move", {property: (this.rules[0].pt || "msg") + "." + this.rules[0].p});
                    } else {
                        return this._("change.label.delete", {property: (this.rules[0].pt || "msg") + "." + this.rules[0].p});
                    }
                } else {
                    return this._("change.label.changeCount", {count: this.rules.length});
                }
            }
        },
        labelStyle: function () {
            return this.name ? "node_label_italic" : "";
        },
        oneditprepare: function () {
            var set = this._("change.action.set");
            var change = this._("change.action.change");
            var del = this._("change.action.delete");
            var move = this._("change.action.move");
            var to = this._("change.action.to");
            var search = this._("change.action.search");
            var replace = this._("change.action.replace");
            var regex = this._("change.label.regex");

            function resizeRule(rule) {
                var newWidth = rule.width();
                rule.find('.red-ui-typedInput').typedInput("width", newWidth - 150);

            }

            $('#node-input-rule-container').css('min-height', '300px').css('min-width', '450px').editableList({
                addItem: function (container, i, opt) {
                    var rule = opt;
                    if (!rule.hasOwnProperty('t')) {
                        rule = {t: "set", p: "payload", to: "", tot: "str"};
                    }
                    if (rule.t === "change" && rule.re) {
                        rule.fromt = 're';
                        delete rule.re;
                    }
                    if (rule.t === "set" && !rule.tot) {
                        if (rule.to.indexOf("msg.") === 0 && !rule.tot) {
                            rule.to = rule.to.substring(4);
                            rule.tot = "msg";
                        } else {
                            rule.tot = "str";
                        }
                    }
                    if (rule.t === "move" && !rule.tot) {
                        rule.tot = "msg";
                    }

                    var row1 = $('<div/>').appendTo(container);
                    var row2 = $('<div/>', {style: "margin-top:8px;"}).appendTo(container);
                    var row3 = $('<div/>', {style: "margin-top:8px;"}).appendTo(container);
                    var row4 = $('<div/>', {style: "margin-top:8px;"}).appendTo(container);

                    var selectField = $('<select/>', {
                        class: "node-input-rule-type",
                        style: "width:110px; margin-right:10px;"
                    }).appendTo(row1);
                    var selectOptions = [{v: "set", l: set}];
                    for (var i = 0; i < selectOptions.length; i++) {
                        selectField.append($("<option></option>").val(selectOptions[i].v).text(selectOptions[i].l));
                    }

                    var propertyName = $('<input/>', {class: "node-input-rule-property-name", type: "text"})
                        .appendTo(row1)
                        .typedInput({types: ['msg']});

                    $('<div/>', {style: "display:inline-block;text-align:right; width:120px; padding-right:10px; box-sizing:border-box;"})
                        .text(to)
                        .appendTo(row2);
                    var propertyValue = $('<input/>', {class: "node-input-rule-property-value", type: "text"})
                        .appendTo(row2)
                        .typedInput({default: 'str', types: ['msg', 'str', 'num', 'bool']});

                    var row3_1 = $('<div/>').appendTo(row3);
                    $('<div/>', {style: "display:inline-block;text-align:right; width:120px; padding-right:10px; box-sizing:border-box;"})
                        .text(search)
                        .appendTo(row3_1);
                    var fromValue = $('<input/>', {class: "node-input-rule-property-search-value", type: "text"})
                        .appendTo(row3_1)
                        .typedInput({default: 'str', types: ['msg', 'str', 'num', 'bool']});

                    var row3_2 = $('<div/>', {style: "margin-top:8px;"}).appendTo(row3);
                    $('<div/>', {style: "display:inline-block;text-align:right; width:120px; padding-right:10px; box-sizing:border-box;"})
                        .text(replace)
                        .appendTo(row3_2);
                    var toValue = $('<input/>', {class: "node-input-rule-property-replace-value", type: "text"})
                        .appendTo(row3_2)
                        .typedInput({default: 'str', types: ['msg', 'str', 'num']});

                    $('<div/>', {style: "display:inline-block;text-align:right; width:120px; padding-right:10px; box-sizing:border-box;"})
                        .text(to)
                        .appendTo(row4);
                    var moveValue = $('<input/>', {class: "node-input-rule-property-move-value", type: "text"})
                        .appendTo(row4)
                        .typedInput({default: 'msg', types: ['msg']});

                    selectField.change(function () {
                        var width = $("#node-input-rule-container").width();
                        var type = $(this).val();
                        if (type == "set") {
                            row2.show();
                            row3.hide();
                            row4.hide();
                        } else if (type == "change") {
                            row2.hide();
                            row3.show();
                            row4.hide();
                        } else if (type == "delete") {
                            row2.hide();
                            row3.hide();
                            row4.hide();
                        } else if (type == "move") {
                            row2.hide();
                            row3.hide();
                            row4.show();
                        }
                        resizeRule(container);
                    });

                    selectField.val(rule.t);
                    propertyName.typedInput('value', rule.p);
                    propertyName.typedInput('type', rule.pt);
                    propertyValue.typedInput('value', rule.to);
                    propertyValue.typedInput('type', rule.tot);
                    moveValue.typedInput('value', rule.to);
                    moveValue.typedInput('type', rule.tot);
                    fromValue.typedInput('value', rule.from);
                    fromValue.typedInput('type', rule.fromt);
                    toValue.typedInput('value', rule.to);
                    toValue.typedInput('type', rule.tot);
                    selectField.change();

                    var newWidth = $("#node-input-rule-container").width();
                    resizeRule(container);
                },
                resizeItem: resizeRule,
                removable: true,
                sortable: true
            });

            if (!this.rules) {
                var rule = {
                    t: (this.action == "replace" ? "set" : this.action),
                    p: this.property,
                    pt: "msg"
                }

                if ((rule.t === "set") || (rule.t === "move")) {
                    rule.to = this.to;
                } else if (rule.t === "change") {
                    rule.from = this.from;
                    rule.to = this.to;
                    rule.re = this.reg;
                }

                delete this.to;
                delete this.from;
                delete this.reg;
                delete this.action;
                delete this.property;

                this.rules = [rule];
            }

            for (var i = 0; i < this.rules.length; i++) {
                var rule = this.rules[i];
                $("#node-input-rule-container").editableList('addItem', rule);
            }
        },
        oneditsave: function () {
            var rules = $("#node-input-rule-container").editableList('items');
            var ruleset;
            var node = this;
            node.rules = [];
            rules.each(function (i) {
                var rule = $(this);
                var type = rule.find(".node-input-rule-type").val();
                var r = {
                    t: type,
                    p: rule.find(".node-input-rule-property-name").typedInput('value'),
                    pt: rule.find(".node-input-rule-property-name").typedInput('type')
                };
                if (type === "set") {
                    r.to = rule.find(".node-input-rule-property-value").typedInput('value');
                    r.tot = rule.find(".node-input-rule-property-value").typedInput('type');
                } else if (type === "move") {
                    r.to = rule.find(".node-input-rule-property-move-value").typedInput('value');
                    r.tot = rule.find(".node-input-rule-property-move-value").typedInput('type');
                } else if (type === "change") {
                    r.from = rule.find(".node-input-rule-property-search-value").typedInput('value');
                    r.fromt = rule.find(".node-input-rule-property-search-value").typedInput('type');
                    r.to = rule.find(".node-input-rule-property-replace-value").typedInput('value');
                    r.tot = rule.find(".node-input-rule-property-replace-value").typedInput('type');
                }
                node.rules.push(r);
            });
        },
        oneditresize: function (size) {
            var rows = $("#dialog-form>div:not(.node-input-rule-container-row)");
            var height = size.height;
            for (var i = 0; i < rows.size(); i++) {
                height -= $(rows[i]).outerHeight(true);
            }
            var editorRow = $("#dialog-form>div.node-input-rule-container-row");
            height -= (parseInt(editorRow.css("marginTop")) + parseInt(editorRow.css("marginBottom")));

            $("#node-input-rule-container").editableList('height', height);
        }
    });
</script><script type="text/x-red" data-template-name="device in">
   <div class="form-row">
       <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
       <input type="text" id="node-input-name">
   </div>
   <div class="form-row">
       <label for="node-input-device"><i class="fa fa-wifi"></i> Device</label>
       <select id="node-input-device" style=""></select>
   </div>
   <div style="display:none">
       <input type='text' id='node-input-_device_id'/>
       <input type='text' id='node-input-_device_label'/>
       <input type='text' id='node-input-_device_type'/>
   </div>
</script>

<script type="text/x-red" data-help-name="device in">
   <p>Use data retrieved from a previously configured sensor as input to logic.</p>
</script>

<script type="text/javascript">
    RED.nodes.registerType('device in', {
        category: 'input',      // the palette category
        defaults: {
            // defines the editable properties of the node

            // just the UI label displayed back to the user on the flow.
            name: { value: "", required: false },
            // name of the device which data is retrieved from.
            device: { value: "", required: true },

            // those are the internal types used when routing data through fiware.
            _device_id: { value: "", required: false },
            _device_label: { value: "", required: false },
            _device_type: { value: "", required: false },
        },
        inputs: 0,                // set the number of inputs - only 0 or 1
        outputs: 1,               // set the number of outputs - 0 to n
        align: "left",          // align the icon
        icon: "bridge-dash.png", // set the icon (held in icons dir below where you save the node)
        color: "#f3b567",        // background-color
        label: function () {
            // sets the default label contents
            return this.name || "device";
        },
        labelStyle: function () {
            // sets the class to apply to the label
            return this.name ? "node_label_italic" : "";
        },
        oneditprepare: function () {
            var select = document.getElementById("node-input-device");
            // this will only work from the device management interface
            let node = this;
            util.GET('/device')
                .then((list) => {
                    list.devices.map((dev) => {
                        select.options[select.options.length] = new Option(dev.label, JSON.stringify({ 'id': dev.id }));
                    });
                    select.value = node.device;
                })
                .catch((error) => {
                    console.error('Failed to retrieve the list of available devices', error);
                })
        },

        oneditsave: function () {
            if ($('#node-input-device').val()) {
                const deviceData = JSON.parse($('#node-input-device').val());
                $('#node-input-_device_id').val(deviceData.id);
                // $('#node-input-_device_label').val($('#node-input-device option:selected').text());
                // $('#node-input-_device_type').val(deviceData.type);
                this._device_id = deviceData.id
            }
        }
    });
</script><script type="text/x-red" data-template-name="device out">
   <div class="form-row">
       <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
       <input type="text" id="node-input-name">
   </div>
   <div class="form-row">
       <label for="node-input-device"><i class="fa fa-wifi"></i> Device</label>
       <select id="node-input-device" style=""></select>
   </div>
   <div class="form-row">
       <label for="node-input-attrs"><i class="fa fa-cube"></i> Source</label>
       <input type="text" id="node-input-attrs" style=""></input>
   </div>

   <div style="display:none">
       <input type='text' id='node-input-_device_id'/>
       <input type='text' id='node-input-_device_label'/>
       <input type='text' id='node-input-_device_type'/>
       <input type='text' id='node-input-_device_templates'/>
   </div>
</script>

<script type="text/x-red" data-help-name="device out">
   <p>Set the value of a virtual device, based on the results of the previous operations on the flow.</p>
</script>

<script type="text/javascript">
    RED.nodes.registerType('device out', {
        category: 'output',      // the palette category
        defaults: {              // defines the editable properties of the node
            name: { value: "", required: false },
            device: { value: undefined, required: true },
            attrs: { value: "", required: true },

            // those are the internal types used when routing data through fiware.
            _device_id: { value: "", required: false },
            _device_label: { value: "", required: false },
            _device_type: { value: "", required: false },
            _device_templates: { value: [], required: false },
        },
        inputs: 1,                // set the number of inputs - only 0 or 1
        outputs: 0,               // set the number of outputs - 0 to n
        align: "right",          // align the icon
        icon: "bridge-dash.png", // set the icon (held in icons dir below where you save the node)
        color: "#f3b567",        // background-color
        label: function () {
            // sets the default label contents
            return this.name || "device";
        },
        labelStyle: function () {
            // sets the class to apply to the label
            return this.name ? "node_label_italic" : "";
        },
        oneditprepare: function () {
            var select = document.getElementById("node-input-device");
            let node = this;
            //  this will only work from the device management interface
            util.GET('/device')
                .then((list) => {
                    console.log(list);
                    list.devices.map((dev) => {
                        let data = {
                            'id': dev.id,
                            'templates': dev.templates
                        }
                        select.options[select.options.length] = new Option(dev.label, JSON.stringify(data));
                    });
                    select.value = node.device;
                })
                .catch((error) => {
                    console.error('Failed to retrieve the list of available devices', error);
                })
        },

        oneditsave: function () {
            if ($('#node-input-device').val()) {
                const deviceData = JSON.parse($('#node-input-device').val());
                $('#node-input-_device_id').val(deviceData.id);
                $('#node-input-_device_templates').val(deviceData.templates);
                // $('#node-input-_device_label').val($('#node-input-device option:selected').text());
                // $('#node-input-_device_type').val(deviceData.type);
                this._device_id = deviceData.id
                this._device_templates = deviceData.templates;
            }
        }
    });
</script><!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/x-red" data-template-name="edgedetection">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
    <div class="form-row">
        <label data-i18n="edgedetection.label.property"></label>
        <input type="text" id="node-input-property" style="width: 70%"/>
    </div>
    <div class="form-row node-input-rule-container-row">
        <ol id="node-input-rule-container"></ol>
    </div>
</script>

<script type="text/x-red" data-help-name="edgedetection">
    <p>A node to route messages based on property values.</p>
    <p>When a message arrives, the selected property is evaluated against each
    of the defined rules. The message is then sent to the output of <i>all</i>
    rules that pass.</p>
    <p><b>Note</b>: the <i>otherwise</i> rule applies as a "not any of" the rules preceding it.</p>
</script>

<script type="text/javascript">
    RED.nodes.registerType('edgedetection', {
        color: "#E2D96E",
        category: 'function',
        defaults: {
            name: {value:""},
            property: {value:"payload", required:true, validate: RED.validators.typedInput("propertyType")},
            propertyType: { value: "msg" },
            rules: {value:[{t: "edge-up", v: ""}]},
            // checkall: {value:"true", required:true},
            outputs: {value:1}
        },
        inputs: 1,
        outputs: 1,
        icon: 'switch.png',
        label: function() {
            return this.name || "edgedetection";
        },
        oneditprepare: function() {
            var node = this;
            var previousValueType = {value: "prev", label: this._("inject.previous"), hasValue: false};

            $("#node-input-property").typedInput({default: this.propertyType || 'msg', types: ['msg']});
            var operators = [
                {v: "edge-up", t: "Edge up"},
                {v: "edge-down", t: "Edge down"}
            ];

            var andLabel = this._("edgedetection.and");
            var caseLabel = this._("edgedetection.ignorecase");

            function resizeRule(rule) {
                var newWidth = rule.width();
                var selectField = rule.find("select");
                var type = selectField.val() || "";
                var valueField = rule.find(".node-input-rule-value");
                var btwnField1 = rule.find(".node-input-rule-btwn-value");
                var btwnField2 = rule.find(".node-input-rule-btwn-value2");
                var selectWidth;

                if (type.length < 4) {
                    selectWidth = 60;
                } else if (type === "regex") {
                    selectWidth = 147;
                } else {
                    selectWidth = 120;
                }

                selectField.width(selectWidth);

                if (type === "btwn") {
                    btwnField1.typedInput("width", (newWidth - selectWidth - 70));
                    btwnField2.typedInput("width", (newWidth - selectWidth - 70));
                } else {
                    if (type === "true" || type === "false" || type === "null" || type === "nnull" || type === "else") {
                        // valueField.hide();
                    } else {
                        valueField.typedInput("width", (newWidth - selectWidth - 70));
                    }
                }
            }

            $("#node-input-rule-container").css('min-height', '250px').css('min-width', '450px').editableList({
                addItem: function(container,i,opt) {
                    if (!opt.hasOwnProperty('r')) {
                        opt.r = {};
                    }
                    var rule = opt.r;
                    if (!rule.hasOwnProperty('t')) {
                        rule.t = 'eq';
                    }
                    var row = $('<div/>').appendTo(container);
                    var row2 = $('<div/>',{style:"padding-top: 5px; padding-left: 175px;"}).appendTo(container);
                    var row3 = $('<div/>',{style:"padding-top: 5px; padding-left: 102px;"}).appendTo(container);
                    var selectField = $('<select/>',{style:"width:120px; margin-left: 5px; text-align: center;"}).appendTo(row);
                    for (var d in operators) {
                        selectField.append($("<option></option>").val(operators[d].v).text(operators[d].t));
                    }
                    var valueField = $('<input/>',{class:"node-input-rule-value", type:"text", style:"margin-left: 5px;"})
                                        .appendTo(row)
                                        .typedInput({default:'num', types:['num']});
                    var btwnValueField = $('<input/>',{class:"node-input-rule-btwn-value", type:"text", style:"margin-left: 5px;"})
                                            .appendTo(row)
                                            .typedInput({default:'num', types:['num']});
                    var btwnAndLabel = $('<span/>',{class:"node-input-rule-btwn-label"})
                                          .text(" " + andLabel + " ")
                                          .appendTo(row3);
                    var btwnValue2Field = $('<input/>',{class:"node-input-rule-btwn-value2", type:"text", style:"margin-left:2px;"})
                                              .appendTo(row3)
                                              .typedInput({default:'num', types:['num']});
                    var finalspan = $('<span/>', {style:"float: right;margin-top: 6px;"}).appendTo(row);
                    finalspan.append(' &#8594; <span class="node-input-rule-index">' + (i+1) + '</span> ');
                    var caseSensitive = $('<input/>',{id:"node-input-rule-case-" + i, class:"node-input-rule-case", type:"checkbox", style:"width:auto;vertical-align:top"}).appendTo(row2);
                    $('<label/>', {for:"node-input-rule-case-" + i, style:"margin-left: 3px;"}).text(caseLabel).appendTo(row2);
                    selectField.change(function() {
                        resizeRule(container);
                        var type = selectField.val();
                        console.log('will change view: ' + type);
                        if (type === "btwn") {
                            valueField.typedInput('hide');
                            btwnValueField.typedInput('show');
                        } else {
                            btwnValueField.typedInput('hide');
                            if (type === "true" || type === "false" || type === "null" || type === "nnull" || type === "else") {
                                valueField.typedInput('hide');
                            } else {
                                valueField.typedInput('show');
                            }
                        }
                        if (type === "regex") {
                            row2.show();
                            row3.hide();
                        } else if (type === "btwn"){
                            row2.hide();
                            row3.show();
                        } else {
                            row2.hide();
                            row3.hide();
                        }
                    });
                    selectField.val(rule.t);
                    if (rule.t == "btwn") {
                        btwnValueField.typedInput('value', rule.v);
                        btwnValueField.typedInput('type', rule.vt||'num');
                        btwnValue2Field.typedInput('value', rule.v2);
                        btwnValue2Field.typedInput('type', rule.v2t||'num');
                    } else if (typeof rule.v != "undefined") {
                        valueField.typedInput('value', rule.v);
                        valueField.typedInput('type', rule.vt||'str');
                    }
                    if (rule.case) {
                        caseSensitive.prop('checked', true);
                    } else {
                        caseSensitive.prop('checked', false);
                    }
                    selectField.change();
                },
                removeItem: function(opt) {
                    if (opt.hasOwnProperty('i')) {
                        var removedList = $("#node-input-rule-container").data('removedList')||[];
                        removedList.push(opt.i);
                        $("#node-input-rule-container").data('removedList', removedList);
                    }

                    var rules = $("#node-input-rule-container").editableList('items');
                    rules.each(function(i) { $(this).find(".node-input-rule-index").html(i+1); });
                },
                resizeItem: resizeRule,
                sortItems: function(rules) {
                    var rules = $("#node-input-rule-container").editableList('items');
                    rules.each(function(i) { $(this).find(".node-input-rule-index").html(i+1); });
                },
                sortable: true,
                removable: true
            });

            for (var i=0; i<this.rules.length; i++) {
                var rule = this.rules[i];
                $("#node-input-rule-container").editableList('addItem',{r:rule,i:i});
            }
        },
        oneditsave: function() {
            var rules = $("#node-input-rule-container").editableList('items');
            var ruleset;
            var node = this;
            node.rules = [];
            var changedOutputs = {};
            var removedList = $("#node-input-rule-container").data('removedList') || [];
            removedList.forEach(function(i) {
                changedOutputs[i] = -1;
            });
            rules.each(function(i) {
                var ruleData = $(this).data('data');
                var rule = $(this);
                var type = rule.find("select").val();
                var r = {t:type};

                if (!(type === "true" || type === "false" || type === "null" || type === "nnull" || type === "else")) {

                    if (type === "btwn") {
                        r.v = rule.find(".node-input-rule-btwn-value").typedInput('value');
                        r.vt = rule.find(".node-input-rule-btwn-value").typedInput('type');
                        r.v2 = rule.find(".node-input-rule-btwn-value2").typedInput('value');
                        r.v2t = rule.find(".node-input-rule-btwn-value2").typedInput('type');
                    } else {
                        r.v = rule.find(".node-input-rule-value").typedInput('value');
                        r.vt = rule.find(".node-input-rule-value").typedInput('type');
                    }

                    if (type === "regex") {
                        r.case = rule.find(".node-input-rule-case").prop("checked");
                    }
                }

                if (ruleData.hasOwnProperty('i')) {
                    if (ruleData.i !== i) {
                        changedOutputs[ruleData.i] = i;
                    }
                }
                node.rules.push(r);
            });

            this._outputs = changedOutputs;
            this.outputs = node.rules.length;
            this.propertyType = $("#node-input-property").typedInput('type');
        },
        oneditresize: function(size) {
            var rows = $("#dialog-form>div:not(.node-input-rule-container-row)");
            var height = size.height;

            for (var i=0; i<rows.size(); i++) {
                height -= $(rows[i]).outerHeight(true);
            }

            var editorRow = $("#dialog-form>div.node-input-rule-container-row");
            height -= (parseInt(editorRow.css("marginTop")) + parseInt(editorRow.css("marginBottom")));
            $("#node-input-rule-container").editableList('height',height);
        }
    });
</script>

<script type="text/x-red" data-template-name="e-mail">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-envelope"></i> <span data-i18n="email.label.from"></span></label>
        <input type="text" id="node-input-from" placeholder="email@address.com">
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-envelope"></i> <span data-i18n="email.label.userid"></span></label>
        <input type="text" id="node-input-userid" placeholder="email@address.com">
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-envelope"></i> <span data-i18n="email.label.password"></span></label>
        <input type="password" id="node-input-password" placeholder="password">
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-envelope"></i> <span data-i18n="email.label.to"></span></label>
        <input type="text" id="node-input-to" placeholder="email@address.com">
    </div>
    <div class="form-row">
        <label for="node-input-server"><i class="fa fa-globe"></i> <span data-i18n="email.label.server"></span></label>
        <input type="text" id="node-input-server" placeholder="gmail-smtp-in.l.google.com">
    </div>
    <div class="form-row">
        <label for="node-input-subject"><i class="fa fa-envelope"></i> <span data-i18n="email.label.subject"></span></label>
        <input type="text" id="node-input-subject" placeholder="Message title">
    </div>
    <div class="form-row">
        <label for="node-input-body"><i class="fa fa-envelope"></i> <span data-i18n="email.label.body"></span></label>
        <input type="text" id="node-input-body" placeholder="Message body">
    </div>
    <div class="form-row">
        <label for="node-input-port"><i class="fa fa-random"></i> <span data-i18n="email.label.port"></span></label>
        <input type="text" id="node-input-port" placeholder="465" style="width:100px">
        <label style="width:40px"> </label>
        <input type="checkbox" id="node-input-secure" style="display:inline-block; width:20px; vertical-align:baseline;">
        Use secure connection.
    </div>
    <br/>
    <div class="form-row">
        <label for="node-input-dname"><i class="fa fa-tag"></i> <span data-i18n="node-red:common.label.name"></span></label>
        <input type="text" id="node-input-dname" data-i18n="[placeholder]node-red:common.label.name">
    </div>
</script>

<script type="text/x-red" data-help-name="e-mail">
    <p>Sends the <code>msg.payload</code> as an email, with a subject of <code>msg.topic</code>.</p>
    <p>The default message recipient can be configured in the node, if it is left
    blank it should be set using the <code>msg.to</code> property of the incoming message. If left blank
    you can also specify <code>msg.cc</code> and/or <code>msg.bcc</code> properties.</p>
    <p>You may optionally set <code>msg.from</code> in the payload which will override the <code>userid</code>
    default value.</p>
    <p>The payload can be html format.</p>
    <p>If the payload is a binary buffer then it will be converted to an attachment.
    The filename should be set using <code>msg.filename</code>. Optionally <code>msg.description</code> can be added for the body text.</p>
    <p>Alternatively you may provide <code>msg.attachments</code> which should contain an array of one or
    more attachments in <a href="https://www.npmjs.com/package/nodemailer#attachments" target="_new">nodemailer</a> format.</p>
    <p>If required by your recipient you may also pass in a <code>msg.envelope</code> object, typically containing extra from and to properties.</p>
    <p>Note: uses SMTP with SSL to port 465.</p>
</script>

<script type="text/javascript">
    (function() {
        RED.nodes.registerType('e-mail',{
            category: 'social-output',
            color:"#c7e9c0",
            defaults: {
                server: {value:"gmail-smtp-in.l.google.com",required:true},
                port: {value:"465",required:true},
                secure: {value: true},
                name: {value:""},
                dname: {value:""},
                to: {required: true},
                from: {required: true},
                subject: {required: true},
                body : {required: true},
                userid: {value:"", required: true},
                password: {value:"", required: true},
            },
            inputs:1,
            outputs:0,
            icon: "envelope.png",
            align: "right",
            label: function() {
                return this.dname||this.name||"email";
            },
            labelStyle: function() {
                return (this.dname||!this.topic)?"node_label_italic":"";
            },
            oneditprepare: function() {
                $("#node-input-body").typedInput({default:'msg',types:['msg']});
            }
        });
    })();
</script>
<!--
  Copyright 2014 IBM Corp.

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/x-red" data-template-name="geofence">
    <div class="form-row">
        <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css" />
        <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.2/leaflet.draw.css" />
        <div id="node-geofence-map" style="width: 100%; height: 400px"></div>
    </div>

    <div class="form-row">
        <label for="node-input-filter">
            <i class="fa fa-sign-in"></i> Filter</label>
        <select id="node-input-filter" value="true" style="width: 70%;">
            <option value="inside">only points inside</option>
            <option value="outside">only points outside</option>
            <option value="enters">enters area</option>
            <option value="exits">exits area</option>
        </select>
    </div>

    <div class="form-row">
        <label for="node-input-name">
            <i class="icon-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Geofence name">
    </div>
</script>


<script type="text/x-red" data-help-name="geofence">
    <p>A simple geofence filter node</p>
    <p>It supports polygons only, and will filter all messages that either fall inside, outside the region or when the device
        enters or exits the region, depending on the selected mode.
    </p>
    <p>If the node is given a name property then
        <b>msg.location.isat</b> will be an array containing a list of named areas that the point is inside of and
        <b>msg.location.distance</b>
        will contain an array of name, distance pairs. Where distance is the dinstance in metres to from the point to the centroid
        of the region.</p>
    <p>This node requires inputs with
        <i>msg.location.lat</i> &amp;
        <i>msg.location.lon</i>
        or
        <i>msg.lat</i> &amp;
        <i>msg.lon</i> values.</p>
</script>

<script type="text/javascript">
    RED.nodes.registerType('geofence', {
        category: 'location',
        color: "#DEBD5C",
        icon: "white-globe.png",
        defaults: {
            name: {
                value: ""
            },
            mode: {
                value: "polyline"
            },
            filter: {
                value: "inside"
            },
            points: {
                value: []
            },
        },
        inputs: 1,
        outputs: 1,
        label: function () {
            return this.name || "geofence";
        },
        labelStyle: function () {
            return this.name ? "node_label_italic" : "";
        },
        oneditprepare: function () {
            function setupMap(node) {
                var map = L.map('node-geofence-map').setView([-22.9223, -47.0406], 7);

                window.node_geofence_map = map;

                // TODO: Change map data source
                L.tileLayer('http://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 20,
                    attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors'
                }).addTo(map);

                var drawnItems = new L.FeatureGroup();
                map.addLayer(drawnItems);

                var drawControl = new L.Control.Draw({
                    draw: {
                        position: 'topleft',
                        polyline: false,
                        marker: false,
                        circle: false
                    },
                    edit: false
                });
                map.addControl(drawControl);

                var drawControl2 = new L.Control.Draw({
                    draw: false,
                    edit: {
                        featureGroup: drawnItems
                    }
                });

                map.on('draw:created', function (e) {
                    console.log("created", e);
                    var type = e.layerType; // never used ???
                    var layer = e.layer;
                    layer.shape = "geofence";
                    drawnItems.addLayer(layer);
                    drawControl.remove();
                    drawControl2.addTo(map);
                });

                map.on('draw:edited', function (e) {
                    console.log("edited", e);
                    var layers = e.layers;
                    layers.eachLayer(function (layer) {
                        layer.shape = "geofence";
                        drawnItems.addLayer(layer);
                    });
                });

                map.on('draw:deleted', function (e) {
                    console.log("deleted", e);
                    //re-enable drawing
                    drawControl2.remove();
                    drawControl.addTo(map);
                });

                // new L.Control.GeoSearch({
                //     provider: new L.GeoSearch.Provider.OpenStreetMap(),
                //     position: 'bottomleft',
                //     showMarker: false,
                //     zoomLevel: 12
                // }).addTo(map);

                if (node.points.length >= 3) {
                    var corners = [];
                    for (x in node.points) {
                        var latlng = L.latLng(node.points[x].latitude, node.points[x].longitude);
                        corners.push(latlng);
                    }
                    var poly = L.polygon(
                        corners
                    );
                    poly.addTo(drawnItems);
                    map.fitBounds(
                        poly.getBounds(), {
                            padding: L.point(30, 30)
                        }
                    );
                    drawControl.remove();
                    drawControl2.addTo(map);
                }

                map.invalidateSize(true);
            }

            // TODO: Change this paths to an adequate value for dojot
            var n = this;
            console.log("loading leaflet");
            // $.getScript('mashup/geofence/js/leaflet/leaflet-src.js')
            $.getScript('https://unpkg.com/leaflet@1.3.1/dist/leaflet.js')
                .done(function (data, textStatus, jqxhr) {
                    // $.getScript('mashup/geofence/js/Leaflet.draw/dist/leaflet.draw.js')
                    $.getScript('https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.2/leaflet.draw.js')
                        .done(function (data, textStatus, jqxhr) {
                            setupMap(n);

                            // $.getScript('mashup/geofence/js/L.GeoSearch/src/js/l.control.geosearch.js')
                            //     .done(function (data, textStatus, jqxhr) {
                            //         $.getScript('mashup/geofence/js/L.GeoSearch/src/js/l.geosearch.provider.openstreetmap.js')
                            //             .done(function (data, textStatus, jqxhr) {
                            //                 setupMap(n);
                            //             })
                            //             .fail(function (jqxhr, settings, exception) {
                            //                 console.log("failed4");
                            //                 console.log(exception);
                            //                 console.log(exception.stack);
                            //             });
                            //     })
                            //     .fail(function (jqxhr, settings, exception) {
                            //         console.log("failed3");
                            //         console.log(exception);
                            //         console.log(exception.stack);
                            //     });
                        })
                        .fail(function (jqxhr, settings, exception) {
                            console.log("failed2");
                            console.log(exception);
                            console.log(exception.stack);
                        });
                })
                .fail(function (jqxhr, settings, exception) {
                    console.log("failed");
                    console.log(exception);
                    console.log(exception.stack);
                });
        },

        oneditsave: function () {
            var map = window.node_geofence_map;
            var n = this;

            map.eachLayer(function (layer) {
                if (layer.shape === "geofence") {
                    console.log("GeoJSON");
                    console.log(layer.toGeoJSON());
                    n.mode = "polyline";
                    n.points = [];
                    n.rad = 0;
                    n.centre = {};
                    for (x in layer._latlngs) {
                        n.points.push({
                            latitude: layer._latlngs[x].lat,
                            longitude: layer._latlngs[x].lng
                        });
                    }
                }
            });
            delete window.node_geofence_map;
        },

        oneditresize: function () {
            if (window.node_geofence_map) {
                window.node_geofence_map.invalidateSize(true);
            }
        }
    });
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/x-red" data-template-name="http-request-out">
    <div class="form-row">
        <label for="node-input-method"><i class="fa fa-tasks"></i> <span data-i18n="httpin.label.method"></span></label>
        <select type="text" id="node-input-method" style="width:70%;">
        <option value="GET">GET</option>
        <option value="POST">POST</option>
        <option value="PUT">PUT</option>
        <option value="DELETE">DELETE</option>
        <option value="use" data-i18n="httpin.setby"></option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-url"><i class="fa fa-globe"></i> <span data-i18n="httpin.label.url"></span></label>
        <input id="node-input-url" type="text" placeholder="http://">
    </div>

    <!--
    <div class="form-row">
        <input type="checkbox" id="node-input-usetls" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-usetls" style="width: auto" data-i18n="httpin.use-tls"></label>
        <div id="node-row-tls" class="hide">
            <label style="width: auto; margin-left: 20px; margin-right: 10px;" for="node-input-tls"><span data-i18n="httpin.tls-config"></span></label><input type="text" style="width: 300px" id="node-input-tls">
        </div>
    </div>

    <div class="form-row">
        <input type="checkbox" id="node-input-useAuth" style="display: inline-block; width: auto; vertical-align: top;">
        <label for="node-input-useAuth" style="width: 70%;"><span data-i18n="httpin.basicauth"></span></label>
        <div style="margin-left: 20px" class="node-input-useAuth-row hide">
            <div class="form-row">
                <label for="node-input-user"><i class="fa fa-user"></i> <span data-i18n="common.label.username"></span></label>
                <input type="text" id="node-input-user">
            </div>
            <div class="form-row">
                <label for="node-input-password"><i class="fa fa-lock"></i> <span data-i18n="common.label.password"></span></label>
                <input type="password" id="node-input-password">
            </div>
        </div>
    </div>
    -->
    <div class="form-row">
      <label for="node-input-body"><i class="fa fa-envelope"></i> <span data-i18n="httpin.label.body"></span></label>
      <input type="text" id="node-input-body" placeholder="Message body">
    </div>

    <div class="form-row">
        <label for="node-input-ret"><i class="fa fa-arrow-left"></i> <span data-i18n="httpin.label.return"></span></label>
        <select type="text" id="node-input-ret" style="width:70%;">
        <option value="txt" data-i18n="httpin.utf8"></opti  on>
        <option value="bin" data-i18n="httpin.binary"></option>
        <option value="obj" data-i18n="httpin.json"></option>
        </select>
    </div>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="httpin.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]httpin.label.name">
    </div>
    <div class="form-tips" id="tip-json" hidden><span data-i18n="httpin.tip.req"></span></div>
</script>

<script type="text/x-red" data-help-name="http-request-out">
    <p>Sends HTTP requests and returns the response.</p>

    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt class="optional">url <span class="property-type">string</span></dt>
        <dd>If not configured in the node, this optional property sets the url of the request.</dd>
        <dt class="optional">method <span class="property-type">string</span></dt>
        <dd>If not configured in the node, this optional property sets the HTTP method of the request.
            Must be one of <code>GET</code>, <code>PUT</code>, <code>POST</code>, <code>PATCH</code> or <code>DELETE</code>.</dd>
        <dt class="optional">headers <span class="property-type">object</span></dt>
        <dd>Sets the HTTP headers of the request.</dd>
        <dt class="optional">cookies <span class="property-type">object</span></dt>
        <dd>If set, can be used to send cookies with the request.</dd>
        <dt class="optional">payload</dt>
        <dd>Sent as the body of the request.</dd>
    </dl>
    <h3>Outputs</h3>
    <dl class="message-properties">
        <dt>payload <span class="property-type">string | object | buffer</span></dt>
        <dd>The body of the response. The node can be configured to return the body
             as a string, attempt to parse it as a JSON string or leave it as a
             binary buffer.</dd>
        <dt>statusCode <span class="property-type">number</span></dt>
        <dd>The status code of the response, or the error code if the request could not be completed.</dd>
        <dt>headers <span class="property-type">object</span></dt>
        <dd>An object containing the response headers.</dd>
        <dt>responseUrl <span class="property-type">string</span></dt>
        <dd>In case any redirects occurred while processing the request, this property is the final redirected url.
            Otherwise, the url of the original request.</dd>
        <dt>responseCookies <span class="property-type">object</span></dt>
        <dd>If the response includes cookies, this propery is an object of name/value pairs for each cookie.</dd>
    </dl>
    <h3>Details</h3>
    <p>When configured within the node, the URL property can contain <a href="http://mustache.github.io/mustache.5.html" target="_blank">mustache-style</a> tags. These allow the
    url to be constructed using values of the incoming message. For example, if the url is set to
    <code>example.com/{{{topic}}}</code>, it will have the value of <code>msg.topic</code> automatically inserted.
    Using {{{...}}} prevents mustache from escaping characters like / & etc.</p>
    <p><b>Note</b>: If running behind a proxy, the standard <code>http_proxy=...</code> environment variable should be set and Node-RED restarted.</p>
    <h4>Using multiple HTTP Request nodes</h4>
    <p>In order to use more than one of these nodes in the same flow, care must be taken with
    the <code>msg.headers</code> property. The first node will set this property with
    the response headers. The next node will then use those headers for its request - this
    is not usually the right thing to do. If <code>msg.headers</code> property is left unchanged
    between nodes, it will be ignored by the second node. To set custom headers, <code>msg.headers</code>
    should first be deleted or reset to an empty object: `{}`.
    <h4>Cookie handling</h4>
    <p>The <code>cookies</code> property passed to the node must be an object of name/value pairs.
    The value can be either a string to set the value of the cookie or it can be an
    object with a single <code>value</code> property.<p>
    <p>Any cookies returned by the request are passed back under the <code>responseCookies</code> property.</p>
    <h4>Content type handling</h4>
    <p>If <code>msg.payload</code> is an Object, the node will automatically set the content type
    of the request to <code>application/json</code> and encode the body as such.</p>
    <p>To encode the request as form data, <code>msg.headers["content-type"]</code> should be set to <code>application/x-www-form-urlencoded</code>.</p>

</script>

<script type="text/javascript">
    RED.nodes.registerType('http-request-out',{
        category: 'output',
        color:"rgb(231, 231, 174)",
        defaults: {
            name: {value:""},
            method:{value:"GET"},
            ret: {value:"txt"},
            body: {value:""},
            url:{value:"",validate:function(v) { return (v.trim().length === 0) || (v.indexOf("://") === -1) || (v.trim().indexOf("http") === 0)} }
            // tls: {type:"tls-config",required: false}
        },
        inputs:1,
        outputs:0,
        icon: "white-globe.png",
        label: function() {
            return this.name||this._("httpin.httpreq");
        },
        labelStyle: function() {
            return this.name?"node_label_italic":"";
        },
        oneditprepare: function() {
            // $("#node-input-useAuth").change(function() {
            //     if ($(this).is(":checked")) {
            //         $(".node-input-useAuth-row").show();
            //     } else {
            //         $(".node-input-useAuth-row").hide();
            //         $('#node-input-user').val('');
            //         $('#node-input-password').val('');
            //     }
            // });
            // if (this.credentials.user || this.credentials.has_password) {
            //     $('#node-input-useAuth').prop('checked', true);
            // } else {
            //     $('#node-input-useAuth').prop('checked', false);
            // }
            // $("#node-input-useAuth").change();

            // function updateTLSOptions() {
            //     if ($("#node-input-usetls").is(':checked')) {
            //         $("#node-row-tls").show();
            //     } else {
            //         $("#node-row-tls").hide();
            //     }
            // }
            // if (this.tls) {
            //     $('#node-input-usetls').prop('checked', true);
            // } else {
            //     $('#node-input-usetls').prop('checked', false);
            // }
            // updateTLSOptions();
            // $("#node-input-usetls").on("click",function() {
            //     updateTLSOptions();
            // });
            $("#node-input-ret").change(function() {
                if ($("#node-input-ret").val() === "obj") {
                    $("#tip-json").show();
                } else {
                    $("#tip-json").hide();
                }
            });
            $("#node-input-body").typedInput({default:'msg',types:['msg']});
        },
        oneditsave: function() {
            // if (!$("#node-input-usetls").is(':checked')) {
            //     $("#node-input-tls").val("_ADD_");
            // }
        }
    });
</script>
<!--
  Copyright JS Foundation and other contributors, http://js.foundation

  Licensed under the Apache License, Version 2.0 (the "License");
  you may not use this file except in compliance with the License.
  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

  Unless required by applicable law or agreed to in writing, software
  distributed under the License is distributed on an "AS IS" BASIS,
  WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
  See the License for the specific language governing permissions and
  limitations under the License.
-->

<script type="text/x-red" data-template-name="switch">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
    <div class="form-row">
        <label data-i18n="switch.label.property"></label>
        <input type="text" id="node-input-property" style="width: 70%"/>
    </div>
    <div class="form-row node-input-rule-container-row">
        <ol id="node-input-rule-container"></ol>
    </div>
    <div class="form-row">
        <select id="node-input-checkall" style="width:100%; margin-right:5px;">
            <option value="true" data-i18n="switch.checkall"></option>
            <option value="false" data-i18n="switch.stopfirst"></option>
        </select>
    </div>
</script>

<script type="text/x-red" data-help-name="switch">
    <p>A node to route messages based on property values.</p>
    <p>When a message arrives, the selected property is evaluated against each
    of the defined rules. The message is then sent to the output of <i>all</i>
    rules that pass.</p>
    <p><b>Note</b>: the <i>otherwise</i> rule applies as a "not any of" the rules preceding it.</p>
</script>

<script type="text/javascript">
    RED.nodes.registerType('switch', {
        color: "#E2D96E",
        category: 'function',
        defaults: {
            name: {value:""},
            property: {value:"payload", required:true, validate: RED.validators.typedInput("propertyType")},
            propertyType: { value:"msg" },
            rules: {value:[{t:"eq", v:""}]},
            checkall: {value:"true", required:true},
            outputs: {value:1}
        },
        inputs: 1,
        outputs: 1,
        icon: "switch.png",
        label: function() {
            return this.name||"switch";
        },
        oneditprepare: function() {
            var node = this;
            var previousValueType = {value:"prev",label:this._("inject.previous"),hasValue:false};

            $("#node-input-property").typedInput({default:this.propertyType||'msg',types:['msg']});
            var operators = [
                {v:"eq",t:"=="},
                {v:"neq",t:"!="},
                {v:"lt",t:"<"},
                {v:"lte",t:"<="},
                {v:"gt",t:">"},
                {v:"gte",t:">="},
                {v:"btwn",t:this._("switch.rules.btwn")},
                {v:"cont",t:this._("switch.rules.cont")},
                {v:"regex",t:this._("switch.rules.regex")},
                {v:"true",t:this._("switch.rules.true")},
                {v:"false",t:this._("switch.rules.false")},
                {v:"null",t:this._("switch.rules.null")},
                {v:"nnull",t:this._("switch.rules.nnull")},
                {v:"else",t:this._("switch.rules.else")}
            ];

            var andLabel = this._("switch.and");
            var caseLabel = this._("switch.ignorecase");

            function resizeRule(rule) {
                var newWidth = rule.width();
                var selectField = rule.find("select");
                var type = selectField.val()||"";
                var valueField = rule.find(".node-input-rule-value");
                var btwnField1 = rule.find(".node-input-rule-btwn-value");
                var btwnField2 = rule.find(".node-input-rule-btwn-value2");
                var selectWidth;
                if (type.length < 4) {
                    selectWidth = 60;
                } else if (type === "regex") {
                    selectWidth = 147;
                } else {
                    selectWidth = 120;
                }
                selectField.width(selectWidth);
                if (type === "btwn") {
                    btwnField1.typedInput("width",(newWidth-selectWidth-70));
                    btwnField2.typedInput("width",(newWidth-selectWidth-70));
                } else {
                    if (type === "true" || type === "false" || type === "null" || type === "nnull" || type === "else") {
                        // valueField.hide();
                    } else {
                        valueField.typedInput("width",(newWidth-selectWidth-70));
                    }
                }
            }

            $("#node-input-rule-container").css('min-height','250px').css('min-width','450px').editableList({
                addItem: function(container,i,opt) {
                    if (!opt.hasOwnProperty('r')) {
                        opt.r = {};
                    }
                    var rule = opt.r;
                    if (!rule.hasOwnProperty('t')) {
                        rule.t = 'eq';
                    }
                    var row = $('<div/>').appendTo(container);
                    var row2 = $('<div/>',{style:"padding-top: 5px; padding-left: 175px;"}).appendTo(container);
                    var row3 = $('<div/>',{style:"padding-top: 5px; padding-left: 102px;"}).appendTo(container);
                    var selectField = $('<select/>',{style:"width:120px; margin-left: 5px; text-align: center;"}).appendTo(row);
                    for (var d in operators) {
                        selectField.append($("<option></option>").val(operators[d].v).text(operators[d].t));
                    }
                    var valueField = $('<input/>',{class:"node-input-rule-value",type:"text",style:"margin-left: 5px;"}).appendTo(row).typedInput({default:'str',types:['str','num']});
                    var btwnValueField = $('<input/>',{class:"node-input-rule-btwn-value",type:"text",style:"margin-left: 5px;"}).appendTo(row).typedInput({default:'num',types:['num']});
                    var btwnAndLabel = $('<span/>',{class:"node-input-rule-btwn-label"}).text(" "+andLabel+" ").appendTo(row3);
                    var btwnValue2Field = $('<input/>',{class:"node-input-rule-btwn-value2",type:"text",style:"margin-left:2px;"}).appendTo(row3).typedInput({default:'num',types:['num']});
                    var finalspan = $('<span/>',{style:"float: right;margin-top: 6px;"}).appendTo(row);
                    finalspan.append(' &#8594; <span class="node-input-rule-index">'+(i+1)+'</span> ');
                    var caseSensitive = $('<input/>',{id:"node-input-rule-case-"+i,class:"node-input-rule-case",type:"checkbox",style:"width:auto;vertical-align:top"}).appendTo(row2);
                    $('<label/>',{for:"node-input-rule-case-"+i,style:"margin-left: 3px;"}).text(caseLabel).appendTo(row2);
                    selectField.change(function() {
                        resizeRule(container);
                        var type = selectField.val();
                        if (type === "btwn") {
                            valueField.typedInput('hide');
                            btwnValueField.typedInput('show');
                        } else {
                            btwnValueField.typedInput('hide');
                            if (type === "true" || type === "false" || type === "null" || type === "nnull" || type === "else") {
                                valueField.typedInput('hide');
                            } else {
                                valueField.typedInput('show');
                            }
                        }
                        if (type === "regex") {
                            row2.show();
                            row3.hide();
                        } else if (type === "btwn"){
                            row2.hide();
                            row3.show();
                        } else {
                            row2.hide();
                            row3.hide();
                        }
                    });
                    selectField.val(rule.t);
                    if (rule.t == "btwn") {
                        btwnValueField.typedInput('value',rule.v);
                        btwnValueField.typedInput('type',rule.vt||'num');
                        btwnValue2Field.typedInput('value',rule.v2);
                        btwnValue2Field.typedInput('type',rule.v2t||'num');
                    } else if (typeof rule.v != "undefined") {
                        valueField.typedInput('value',rule.v);
                        valueField.typedInput('type',rule.vt||'str');
                    }
                    if (rule.case) {
                        caseSensitive.prop('checked',true);
                    } else {
                        caseSensitive.prop('checked',false);
                    }
                    selectField.change();
                },
                removeItem: function(opt) {
                    if (opt.hasOwnProperty('i')) {
                        var removedList = $("#node-input-rule-container").data('removedList')||[];
                        removedList.push(opt.i);
                        $("#node-input-rule-container").data('removedList',removedList);
                    }

                    var rules = $("#node-input-rule-container").editableList('items');
                    rules.each(function(i) { $(this).find(".node-input-rule-index").html(i+1); });
                },
                resizeItem: resizeRule,
                sortItems: function(rules) {
                    var rules = $("#node-input-rule-container").editableList('items');
                    rules.each(function(i) { $(this).find(".node-input-rule-index").html(i+1); });
                },
                sortable: true,
                removable: true
            });

            for (var i=0;i<this.rules.length;i++) {
                var rule = this.rules[i];
                $("#node-input-rule-container").editableList('addItem',{r:rule,i:i});
            }
        },
        oneditsave: function() {
            var rules = $("#node-input-rule-container").editableList('items');
            var ruleset;
            var node = this;
            node.rules = [];
            var changedOutputs = {};
            var removedList = $("#node-input-rule-container").data('removedList')||[];
            removedList.forEach(function(i) {
                changedOutputs[i] = -1;
            });
            rules.each(function(i) {
                var ruleData = $(this).data('data');
                var rule = $(this);
                var type = rule.find("select").val();
                var r = {t:type};
                if (!(type === "true" || type === "false" || type === "null" || type === "nnull" || type === "else")) {
                    if (type === "btwn") {
                        r.v = rule.find(".node-input-rule-btwn-value").typedInput('value');
                        r.vt = rule.find(".node-input-rule-btwn-value").typedInput('type');
                        r.v2 = rule.find(".node-input-rule-btwn-value2").typedInput('value');
                        r.v2t = rule.find(".node-input-rule-btwn-value2").typedInput('type');
                    } else {
                        r.v = rule.find(".node-input-rule-value").typedInput('value');
                        r.vt = rule.find(".node-input-rule-value").typedInput('type');
                    }
                    if (type === "regex") {
                        r.case = rule.find(".node-input-rule-case").prop("checked");
                    }
                }
                if (ruleData.hasOwnProperty('i')) {
                    if (ruleData.i !== i) {
                        changedOutputs[ruleData.i] = i;
                    }
                }
                node.rules.push(r);
            });
            this._outputs = changedOutputs;
            this.outputs = node.rules.length;
            this.propertyType = $("#node-input-property").typedInput('type');
        },
        oneditresize: function(size) {
            var rows = $("#dialog-form>div:not(.node-input-rule-container-row)");
            var height = size.height;
            for (var i=0;i<rows.size();i++) {
                height -= $(rows[i]).outerHeight(true);
            }
            var editorRow = $("#dialog-form>div.node-input-rule-container-row");
            height -= (parseInt(editorRow.css("marginTop"))+parseInt(editorRow.css("marginBottom")));
            $("#node-input-rule-container").editableList('height',height);
        }
    });
</script>
<script type="text/x-red" data-template-name="device template in">
  <div class="form-row">
      <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
      <input type="text" id="node-input-name">
  </div>
  <div class="form-row">
      <label for="node-input-device-template"><i class="fa fa-wifi"></i> Device Template</label>
      <select id="node-input-device-template" style=""></select>
  </div>
  <div style="display:none">
      <input type='text' id='node-input-device-template-label'/>
      <input type='text' id='node-input-device-template-id'/>
  </div>
</script>

<script type="text/x-red" data-help-name="device template in">
  <p>Use data retrieved from a previously configured sensor as input to logic.</p>
</script>

<script type="text/javascript">
   RED.nodes.registerType('device template in',{
       category: 'input',      // the palette category
       defaults: {
           // defines the editable properties of the node

           // just the UI label displayed back to the user on the flow.
           name: {value:"", required:false},
           // name of the device which data is retrieved from.
           device_template: {value:"", required:true},

           // those are the internal types used when routing data through fiware.
           _device_template_label: { value:"", required: false},
           _device_template_id: { value:"", required: false}
       },
       inputs:0,                // set the number of inputs - only 0 or 1
       outputs:1,               // set the number of outputs - 0 to n
       align: "left",          // align the icon
       icon: "bridge-dash.png", // set the icon (held in icons dir below where you save the node)
       color: "#679BF3",        // background-color
       label: function() {
           // sets the default label contents
           return this.name || "device template";
       },
       labelStyle: function() {
           // sets the class to apply to the label
           return this.name ? "node_label_italic" : "";
       },
       oneditprepare: function() {
         var select = document.getElementById("node-input-device-template");
         let node = this;
         util.GET('/template')
            .then((list) => {
              list.templates.map((templ) => {
                select.options[select.options.length] = new Option(templ.label, JSON.stringify({"label" : templ.label, "id": templ.id}));
              });
              select.value = templ.label;
            })
            .catch((error) => {
              console.error('Failed to retrieve the list of available devices',error);
            })
       },

       oneditsave: function() {
         if ($('#node-input-device-template').val()) {
           const deviceData = JSON.parse($('#node-input-device-template').val());
           $('#node-input-device-template-label').val(deviceData.label);
           $('#node-input-device-template-id').val(deviceData.id);
           this._device_template_label = deviceData.label;
           this._device_template_id = deviceData.id;
           this.device_template = deviceData;
         }
       }
   });
</script>
<script type="text/x-red" data-template-name="template">
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <span data-i18n="common.label.name"></span></label>
        <input type="text" id="node-input-name" data-i18n="[placeholder]common.label.name">
    </div>
    <div class="form-row">
        <label for="node-input-field"><i class="fa fa-edit"></i> <span data-i18n="template.label.property"></span></label>
        <input type="text" id="node-input-field" placeholder="payload" style="width:250px;">
        <input type="hidden" id="node-input-fieldType">
    </div>
    <div class="form-row">
        <label for="node-input-syntax"><i class="fa fa-code"></i> <span data-i18n="template.label.syntax"></span></label>
        <select id="node-input-syntax" style="width:180px;">
            <option value="mustache" data-i18n="template.label.mustache"></option>
            <option value="plain" data-i18n="template.label.plain"></option>
        </select>
    </div>

    <div class="form-row" style="position: relative; margin-bottom: 0px;">
        <label for="node-input-template"><i class="fa fa-file-code-o"></i> <span data-i18n="template.label.template"></span></label>
        <input type="hidden" id="node-input-template" autofocus="autofocus">
        <div style="position: absolute; right:0;display:inline-block; text-align: right; font-size: 0.8em;">
            <span data-i18n="template.label.format"></span>:
            <select id="node-input-format" style="width:110px; font-size: 10px !important;  height: 24px; padding:0;">
                <option value="handlebars">mustache</option>
                <option value="html">HTML</option>
                <option value="json">JSON</option>
                <option value="javascript">Javascript</option>
                <option value="css">CSS</option>
                <option value="markdown">Markdown</option>
                <option value="yaml">YAML</option>
                <option value="text" data-i18n="template.label.none"></option>
            </select>
        </div>
    </div>
    <div class="form-row node-text-editor-row">
        <div style="height: 250px; min-height:150px;" class="node-text-editor" id="node-input-template-editor" ></div>
    </div>
    <div class="form-row">
        <label for="node-input-output"><i class="fa fa-long-arrow-right"></i> <span data-i18n="template.label.output"></span></label>
        <select id="node-input-output" style="width:180px;">
            <option value="str" data-i18n="template.label.plain"></option>
            <option value="json" data-i18n="template.label.json"></option>
        </select>
    </div>

</script>

<script type="text/x-red" data-help-name="template">
    <p>Sets a property based on the provided template.</p>
    <h3>Inputs</h3>
    <dl class="message-properties">
        <dt>msg <span class="property-type">object</span></dt>
        <dd>A msg object containing information to populate the template.</dd>
    </dl>
    <h3>Outputs</h3>
    <dl class="message-properties">
        <dt>msg <span class="property-type">object</span></dt>
        <dd>a msg with a property set by populating the configured template with properties from the incoming msg.</dd>
    </dl>
    <h3>Details</h3>
    <p>By default this uses the <i><a href="http://mustache.github.io/mustache.5.html" target="_blank">mustache</a></i>
    format, but this can be switched off if required.</p>
    <p>For example, when a template of:
    <pre>Hello {{payload.name}}. Today is {{date}}</pre>
    <p>receives a message containing:
    <pre>{
  date: "Monday"
  payload: {
    name: "Fred",
  }
}</pre>
    <p>The resulting property will be:
    <pre>Hello Fred. Today is Monday</pre>
    <p>It is possible to use a property from the flow context or global context. Just use <code>{{flow.name}}</code> or <code>{{global.name}}</code>.
    <p><b>Note: </b>By default, <i>mustache</i> will escape any HTML entities in the values it substitutes.
       To prevent this, use <code>{{{triple}}}</code> braces.
</script>

<script type="text/javascript">
    RED.nodes.registerType('template',{
        color:"rgb(243, 181, 103)",
        category: 'function',
        defaults: {
            name: {value:""},
            field: {value:"payload", validate: RED.validators.typedInput("fieldType")},
            fieldType: {value:"msg"},
            format: {value:"handlebars"},
            syntax: {value:"mustache"},
            template: {value:"This is the payload: {{payload}} !"},
            output: {value:"str"}
        },
        inputs:1,
        outputs:1,
        icon: "template.png",
        label: function() {
            return this.name || "template";
        },
        oneditprepare: function() {
            var that = this;
            if (!this.fieldType) {
                this.fieldType = 'msg';
            }
            if (!this.syntax) {
                this.syntax = 'mustache';
                $("#node-input-syntax").val(this.syntax);
            }
            $("#node-input-field").typedInput({
                default: 'msg',
                types: ['msg','flow','global'],
                typeField: $("#node-input-fieldType")
            });

            this.editor = RED.editor.createEditor({
                id: 'node-input-template-editor',
                mode: 'ace/mode/html',
                value: $("#node-input-template").val()
            });
            RED.library.create({
                url:"functions", // where to get the data from
                type:"function", // the type of object the library is for
                editor:that.editor, // the field name the main text body goes to
                fields:['name','outputs']
            });
            this.editor.focus();

            $("#node-input-format").change(function() {
                var mod = "ace/mode/"+$("#node-input-format").val();
                that.editor.getSession().setMode({
                    path: mod,
                    v: Date.now()
                });
            });
        },
        oneditsave: function() {
            $("#node-input-template").val(this.editor.getValue());
            this.editor.destroy();
            delete this.editor;
        },
        oneditcancel: function() {
            this.editor.destroy();
            delete this.editor;
        },
        oneditresize: function(size) {
            var rows = $("#dialog-form>div:not(.node-text-editor-row)");
            var height = $("#dialog-form").height();
            for (var i=0; i<rows.size(); i++) {
                height -= $(rows[i]).outerHeight(true);
            }
            var editorRow = $("#dialog-form>div.node-text-editor-row");
            height -= (parseInt(editorRow.css("marginTop"))+parseInt(editorRow.css("marginBottom")));
            $(".node-text-editor").css("height",height+"px");
            this.editor.resize();
        }
    });
</script>
